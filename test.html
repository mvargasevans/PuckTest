<html>
 <head>
 </head>
 <body>
  <script src="https://www.puck-js.com/puck.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js"></script>

  <button onclick="Puck.write("\x10sendData()\n");">On!</button>
  <button onclick="Puck.write('LED1.reset();\n');">Off!</button>
  <button id="myBtn">Try it</button>
	 
	 <a href='#' 
        onclick='downloadCSV({ filename: "stock-data.csv" });'
    >Download CSV</a>
  
  <div class = "container">
        <canvas id="myChart"></canvas>
    </div>
 <script>
  
	 var myLabels = [];


let myChart = document.getElementById('myChart');//.getContext('2d');
        Chart.defaults.global.defaultColor = '#000000'; 
	 
       let massPopChart = new Chart(myChart, {
  type: 'line',
  data: {
    labels: myLabels,
    datasets: [{ 
        data: [],
        label: "Ruuvitag at 100 Hz",
        borderColor: "#3e95cd",
        fill: false
      }]
  },
  options: {
    title: {
      display: true,
      text: 'Vibration'
    }
  }
});
  
	 
  var myData = [];
  var i = 0;
	 
  function onLine(data) {
  console.log(data);
   myData.push(parseFloat(data));
	  myLabels.push(i)
	  i++;
	  if (i == 1500) {
	  downloadCSV(myData);
	  }
  // debugger;
   massPopChart.data.datasets[0].data = myData;
	  massPopChart.data.labels = myLabels;
   massPopChart.update();
}

var connection;
document.getElementById("myBtn").addEventListener("click", function() {
	myData = [];
	myLabels = [];
	i = 0
	 massPopChart.data.datasets[0].data = myData;
	  massPopChart.data.labels = myLabels;
   massPopChart.update();
  if (connection) {
    connection.close();
    connection = undefined;
  }
  Puck.connect(function(c) {
    if (!c) {
      alert("Couldn't connect!");
      return;
    }
    connection = c;
    // Handle the data we get back, and call 'onLine'
    // whenever we get a line
    var buf = "";
    connection.on("data", function(d) {
      buf += d;
      var i = buf.indexOf("\n");
      while (i>=0) {
        onLine(buf.substr(0,i));
        buf = buf.substr(i+1);
        i = buf.indexOf("\n");
      }
    });
    // Request data from Puck.js
    connection.write("\x10sendData()\n");
  });
});
	 
	 function convertArrayOfObjectsToCSV(args) {  
        var result, ctr, keys, columnDelimiter, lineDelimiter, data;

        data = args.data || null;
        if (data == null || !data.length) {
            return null;
        }

        columnDelimiter = args.columnDelimiter || ',';
        lineDelimiter = args.lineDelimiter || '\n';

        keys = Object.keys(data[0]);

        result = '';
        result += keys.join(columnDelimiter);
        result += lineDelimiter;

        data.forEach(function(item) {
            ctr = 0;
            keys.forEach(function(key) {
                if (ctr > 0) result += columnDelimiter;

                result += item[key];
                ctr++;
            });
            result += lineDelimiter;
        });

        return result;
    }
	 
	 function downloadCSV(args) {  
        var data, filename, link;
        var csv = convertArrayOfObjectsToCSV({
            data: myData
        });
        if (csv == null) return;

        filename = args.filename || 'export.csv';

        if (!csv.match(/^data:text\/csv/i)) {
            csv = 'data:text/csv;charset=utf-8,' + csv;
        }
        data = encodeURI(csv);

        link = document.createElement('a');
        link.setAttribute('href', data);
        link.setAttribute('download', filename);
        link.click();
    }
	 
  </script>
 </body>
</html>
